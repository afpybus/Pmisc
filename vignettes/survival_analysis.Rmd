---
title: "Survival Analysis with Pmisc"
author: "Alyssa Pybus"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Survival Analysis with Pmisc}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>",
    fig.width = 7,
    fig.height = 5
)
```

## Introduction

The Pmisc package includes several functions for survival analysis, making it easy to:

- Test multiple features for association with survival using Cox proportional hazards models
- Create publication-ready Kaplan-Meier survival curves
- Visualize survival results with volcano plots
- Explore relationships between gene expression and overall survival

These functions provide a streamlined wrapper around the **`survival`**, **`tidycmprsk`**, and **`ggsurvfit`** packages.

This vignette demonstrates these functions using the `lung` dataset from the survival package.

## Load Packages

```{r load, message=FALSE, warning=FALSE}
library(Pmisc)
library(dplyr)
library(ggplot2)
library(survival)
library(tibble)
```

## The Lung Cancer Dataset

The `lung` dataset contains survival data from patients with advanced lung cancer:

```{r explore_data}
# Load the lung dataset
data(lung)

# Preview the data
head(lung) %>% knitr::kable()

# Summary of key variables
summary(lung[, c("time", "status", "age", "sex", "ph.ecog")])
```

**Key variables:**

- `time`: Survival time in days
- `status`: Censoring status (1 = censored, 2 = dead)
- `age`: Age in years
- `sex`: 1 = male, 2 = female
- `ph.ecog`: ECOG performance score (0-3)

## Standardizing the Data

The Pmisc survival functions expect `status` coded as 0/1 (0 = censored, 1 = event). Let's prepare the data:

```{r prepare_data}
# Prepare the lung dataset
lung_prep <- lung %>%
    mutate(
        status = status - 1, # Convert 1/2 to 0/1
        sex_binary = sex - 1 # Convert to 0/1 for easier interpretation
    ) %>%
    filter(!is.na(time), !is.na(status)) # Remove missing values

# Verify the conversion
table(lung_prep$status)
```

## Cox Proportional Hazards Analysis

The `coxph_all()` function tests multiple features simultaneously for association with survival:

```{r coxph_all}
# Define features to test
features <- c("age", "sex_binary", "ph.ecog", "ph.karno", "pat.karno", "wt.loss")

# Run Cox proportional hazards for all features
cox_results <- coxph_all(
    df = lung_prep,
    feature.names = features,
    time_col = "time",
    status_col = "status"
)

# View results
cox_results %>%
    select(feature, n, hazard_ratio, wald_p, p.adj, p.signif, result) %>%
    knitr::kable(digits = 4)
```

**Interpreting the results:**

- **Hazard ratio > 1**: Higher feature values associated with increased risk of death
- **Hazard ratio < 1**: Higher feature values associated with decreased risk of death
- **p.adj**: Adjusted p-value (FDR correction)
- **result**: Classification (Increased Hazard, Decreased Hazard, or ns)

In this example:

- **sex_binary** shows decreased hazard (females have better survival)
- **ph.ecog** shows increased hazard (worse performance status = worse survival)

## Survival Volcano Plot

Visualize the Cox regression results with a volcano plot:

```{r survival_volcano}
survival_volcano(cox_results) +
    ggtitle("Survival Analysis: Lung Cancer Dataset")
```

**Reading the plot:**

- X-axis: Hazard ratio (1.0 = no effect)
- Y-axis: -log10(adjusted p-value)
- Vertical dashed line: Hazard ratio = 1 (no effect)
- Horizontal dashed line: p = 0.05 significance threshold
- Colors: Direction of effect (increased vs decreased hazard)

### Customizing Volcano Colors with scm()

You can control the exact colors of the volcano plot using the `scm()` helper:

```{r custom_volcano}
# Define custom colors for hazard categories
volcano_colors <- tibble(
    breaks = c("Increased Hazard", "Decreased Hazard", "ns"),
    values = c("red3", "blue3", "grey80")
)

# Apply to plot
survival_volcano(cox_results) +
    scm(volcano_colors) + # Apply custom color scale
    ggtitle("Survival Volcano with Custom Colors")
```

## Kaplan-Meier Survival Curves

The `KM_categorical()` function creates Kaplan-Meier curves for categorical or continuous variables:

### Binary Variable: Sex

```{r km_sex}
# Create categorical variable for sex
lung_km <- lung_prep %>%
    mutate(sex_cat = ifelse(sex_binary == 1, "Female", "Male"))

# Kaplan-Meier plot by sex
KM_categorical(
    df = lung_km,
    gene = "sex", # Column name prefix
    time_scale = "Time (days)",
    reclass = FALSE # Don't split by median since already categorical
)
```

### Continuous Variable: Age

For continuous variables, `KM_categorical()` automatically splits at the median:

```{r km_age}
# Kaplan-Meier plot for age (split at median)
KM_categorical(
    df = lung_prep,
    gene = "age",
    time_scale = "Time (days)",
    reclass = TRUE # Split continuous variable at median
) +
    ggtitle("Survival by Age (Median Split)")
```

### ECOG Performance Score

```{r km_ecog}
# Create binary ECOG variable (good vs poor performance)
lung_ecog <- lung_prep %>%
    filter(!is.na(ph.ecog)) %>%
    mutate(ph.ecog_cat = ifelse(ph.ecog <= 1, "Good (0-1)", "Poor (2-3)"))

KM_categorical(
    df = lung_ecog,
    gene = "ph.ecog",
    time_scale = "Time (days)",
    reclass = FALSE
) +
    ggtitle("Survival by ECOG Performance Status")
```

## Gene Expression vs Overall Survival

The `gene_OS_scatter()` function creates scatter plots showing the relationship between a feature and survival time:

```{r gene_os_scatter}
gene_OS_scatter(
    df = lung_prep,
    gene = "age"
) +
    ggtitle("Age vs Survival Time")
```

**Plot elements:**

- Each point represents one patient
- Color indicates vital status (alive vs dead)
- Dashed lines show medians (survival time and gene expression)
- Ellipses show 68% confidence regions
- Vertical line at 60 months (5-year survival)

```{r gene_os_scatter_wt}
# Another example: Weight loss vs survival
lung_wt <- lung_prep %>% filter(!is.na(wt.loss))

gene_OS_scatter(
    df = lung_wt,
    gene = "wt.loss"
) +
    ggtitle("Weight Loss vs Survival Time")
```

## Complete Workflow Example

Here's a complete analysis workflow:

```{r complete_workflow}
# 1. Prepare data
lung_analysis <- lung %>%
    mutate(
        status = status - 1,
        Female = (sex == 2) * 1,
        Elderly = (age >= 65) * 1
    ) %>%
    filter(!is.na(time), !is.na(status))

# 2. Test multiple features
features_test <- c("age", "Female", "Elderly", "ph.ecog", "ph.karno", "meal.cal", "wt.loss")

cox_results_full <- coxph_all(
    df = lung_analysis,
    feature.names = features_test,
    time_col = "time",
    status_col = "status"
)

# 3. View significant results
cox_results_full %>%
    filter(p.signif != "ns") %>%
    select(feature, hazard_ratio, p.adj, result) %>%
    arrange(p.adj) %>%
    knitr::kable(digits = 4)

# 4. Visualize results
survival_volcano(cox_results_full) +
    ggtitle("Survival Analysis: Comprehensive Feature Testing")
```

## Advanced: Custom Survival Analysis

For more complex analyses, you can combine Pmisc functions with base survival functions:

```{r advanced_example}
# Test interaction between sex and age
lung_interaction <- lung_prep %>%
    mutate(
        age_group = cut(age,
            breaks = c(0, 60, 70, 100),
            labels = c("Young", "Middle", "Old")
        ),
        sex_label = ifelse(sex_binary == 1, "Female", "Male")
    ) %>%
    filter(!is.na(age_group))

# Run Cox model with interaction
cox_interaction <- coxph(Surv(time, status) ~ age_group * sex_label,
    data = lung_interaction
)

summary(cox_interaction)
```

## Interpreting Hazard Ratios

- **HR = 1.0**: No effect on survival
- **HR = 2.0**: Doubling of risk (twice as likely to experience event)
- **HR = 0.5**: Halving of risk (half as likely to experience event)

Examples from our analysis:

- Female sex (HR ≈ 0.59): Females have ~41% lower risk of death than males
- ECOG score (HR ≈ 1.62): Each 1-point increase in ECOG score increases risk by ~62%

## Summary

The Pmisc survival analysis functions provide:

1. **Batch testing** with `coxph_all()` - Test many features at once
2. **Automatic correction** - FDR adjustment for multiple testing
3. **Visual summaries** - Volcano plots and Kaplan-Meier curves
4. **Exploration tools** - Scatter plots linking expression to survival
5. **Sample size validation** - Removes features with insufficient data

These tools are particularly useful for:

- Biomarker discovery in clinical studies
- Gene expression and survival associations
- Prognostic factor identification
- Exploratory survival analysis

## Related Functions

- `coxph_all()`: Cox proportional hazards for multiple features
- `survival_volcano()`: Volcano plot for survival results
- `KM_categorical()`: Kaplan-Meier survival curves
- `gene_OS_scatter()`: Gene expression vs overall survival scatter plot
