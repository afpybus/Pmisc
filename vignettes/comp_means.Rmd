---
title: "Statistical Comparisons with comp_means"
author: "Alyssa Pybus"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Statistical Comparisons with comp_means}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


**[GitHub Repository](https://github.com/afpybus/Pmisc)**

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>",
    fig.width = 7,
    fig.height = 5,
    fig.path = "figures/comp_means-",
    dev = "png"
)
```

## Introduction

The `comp_means()` function in Pmisc provides a streamlined way to perform **pairwise statistical comparisons** across multiple features **between two groups**. It automatically handles:

- Statistical tests for two-group comparisons (t-test, Wilcoxon)
- P-value adjustment for multiple testing
- Calculation of fold changes and mean differences
- Sample size validation

**Important:** This function is designed for comparing exactly **two groups**. For multi-group comparisons, filter your data to two groups at a time.

It wraps the powerful **`ggpubr`** package functions to provide a more opinionated, high-throughput workflow.

This vignette demonstrates the function using a **simulated gene expression dataset** with 50 genes across two experimental groups (Control vs Treatment), showcasing the function's capability for high-throughput multivariate analysis.

## Load Package

```{r load}
library(Pmisc)
library(dplyr)
library(ggplot2)
library(tibble)
```

## Simulating Gene Expression Data

To demonstrate the function's capability with high-dimensional data, let's simulate a gene expression dataset with 50 genes across two experimental groups: "Control" and "Treatment".

```{r simulate_data}
set.seed(123) # For reproducibility

# 1. Create sample metadata
n_samples <- 20 # 10 per group
metadata <- data.frame(
    sample_id = paste0("S", 1:n_samples),
    group = rep(c("Control", "Treatment"), each = n_samples / 2),
    stringsAsFactors = FALSE
)

# 2. Simulate gene expression matrix (50 genes)
# Most genes will be unchanged, some will be differentially expressed
genes <- paste0("Gene_", 1:50)
expression_data <- matrix(rnorm(n_samples * 50, mean = 10, sd = 2), nrow = n_samples)
colnames(expression_data) <- genes

# Convert to data frame and add group info
df_genes <- cbind(metadata, as.data.frame(expression_data))

# 3. Introduce signal (Differential Expression)
# Upregulate 5 genes in Treatment
up_genes <- c("Gene_1", "Gene_2", "Gene_3", "Gene_4", "Gene_5")
df_genes[df_genes$group == "Treatment", up_genes] <- df_genes[df_genes$group == "Treatment", up_genes] + 3

# Downregulate 5 genes in Treatment
down_genes <- c("Gene_6", "Gene_7", "Gene_8", "Gene_9", "Gene_10")
df_genes[df_genes$group == "Treatment", down_genes] <- df_genes[df_genes$group == "Treatment", down_genes] - 3

# View structure
head(df_genes[, c("sample_id", "group", "Gene_1", "Gene_6", "Gene_50")])
```

## Running the Comparison

Now we run `comp_means()` on all 50 genes simultaneously.

```{r run_comparison}
# Define all gene columns as features
features <- genes

# Run comparison
results <- comp_means(
    df = df_genes,
    feature_column_names = features,
    group_column_name = "group",
    compare_means_method = "t.test",
    p.adjust_method = "fdr"
)

# View top significant results
results %>%
    filter(p.adj < 0.05) %>%
    arrange(p.adj) %>%
    select(feature, group1, group2, mean_dif, p.adj, p.adj.signif) %>%
    head(10) %>%
    knitr::kable(digits = 4)
```

## Volcano Plot Visualization

With 50 variables, the volcano plot becomes a powerful tool to visualize the overall landscape of differential expression.

```{r volcano_plot}
# Define colors: Control (blue), Treatment (red), ns (gray)
# Note: "Control" is the reference, so "Treatment" is the comparison group
sig_colors <- data.frame(
    breaks = c("Control", "Treatment", "ns"),
    values = c("dodgerblue", "firebrick", "grey80"),
    stringsAsFactors = FALSE
)

# Create volcano plot
volcano_cm(
    comp_means_output = results,
    x = "mean_dif",
    max_overlaps = 20
) +
    scm(sig_colors) +
    ggtitle("Differential Expression: Treatment vs Control")
```

The plot clearly shows our simulated signal:
- **Red points (Right)**: Genes upregulated in Treatment (Gene_1 to Gene_5)
- **Blue points (Left)**: Genes higher in Control (meaning downregulated in Treatment) (Gene_6 to Gene_10)
- **Gray points (Bottom/Middle)**: Unchanged background genes

## Visualizing Top Hits

We can verify our top hits using boxplots.

```{r boxplot, fig.height=4}
# Visualize top upregulated gene
p1 <- DEF_boxplot(
    data = df_genes,
    DE = results,
    feature = "Gene_1", # Known upregulated
    grouping = "group"
) + ggtitle("Gene_1 (Upregulated)")

# Visualize top downregulated gene
p2 <- DEF_boxplot(
    data = df_genes,
    DE = results,
    feature = "Gene_6", # Known downregulated
    grouping = "group"
) + ggtitle("Gene_6 (Downregulated)")

# Arrange side by side
ggpubr::ggarrange(p1, p2, ncol = 2)
```

## Non-Parametric Tests (Wilcoxon)

We can also perform the same broad comparison using the Wilcoxon test.

```{r wilcoxon}
# Run Wilcoxon test on all genes
results_wilcox <- comp_means(
    df = df_genes,
    feature_column_names = features,
    group_column_name = "group",
    compare_means_method = "wilcox.test",
    p.adjust_method = "fdr"
)

# Compare p-values for a specific gene (e.g., Gene_1)
comparison <- data.frame(
    feature = "Gene_1",
    t_test_p = format.pval(results$p.adj[results$feature == "Gene_1"], digits = 3, eps = 0.001),
    wilcox_p = format.pval(results_wilcox$p.adj[results_wilcox$feature == "Gene_1"], digits = 3, eps = 0.001)
)

knitr::kable(comparison)
```

## Summary

The `comp_means()` function provides:

1. **Flexible testing**: Support for t-test, Wilcoxon, and ANOVA
2. **Multiple testing correction**: FDR, Bonferroni, Holm, and others
3. **Rich output**: Means, fold changes, p-values, and significance labels
4. **Integration**: Works seamlessly with volcano plots and boxplots
5. **Sample size checking**: Automatically removes features with insufficient data

This makes it ideal for exploratory analysis, differential expression studies, and comparing measurements across experimental groups.

## Related Functions

- `p.readjust()`: Re-adjust p-values from comp_means output
- `volcano_cm()`: Create volcano plots
- `volcano_cm_labelall()`: Volcano plot labeling all points
- `DEF_boxplot()`: Boxplot with p-value annotations
- `DEF_boxplot_sig()`: Boxplot with significance stars
